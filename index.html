<html>

<head>

  <meta charset='utf-8' />
  <title> km.L </title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.mapbox.com/mapbox-gl-js/v0.51.0/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v0.51.0/mapbox-gl.css' rel='stylesheet' />
  <script src='mapbox-gl-sync-move.js'></script>
  <link rel="stylesheet" type="text/css" href="style_Midcentury_SplitScreen.css">
  <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">




</head>


<body>

  <div id='mapLeft'></div>
  <div id='mapRight'></div>


  <div id='middleDivider'></div>

  <div id='console'>
    <img src ='kmLABS_LOGOwhite.png' alt = 'km.L'
                                 style = 'width:105px;height:32px;margin-top:5px;'>
    <!--legend -->

    <div class='session'>

      <div id = 'CtoFconverter' class = 'CtoF'>
        <h2>Temperature</h2>
        <form style="display: inline-block">
            <input  type="radio" name="CtoFbutton" value="celcius" checked> &deg;C
            <input  type="radio" name="CtoFbutton" value="satellite"> &deg;F
        </form>
      </div>

      <div class = "scale">
        <div class = "color" style = "background: #fef0d9"></div>
        <div class = "color" style = "background: #fdcc8a"></div>
        <div class = "color" style = "background: #fc8d59"></div>
        <div class = "color" style = "background: #e34a33"></div>
        <div class = "color" style = "background: #b30000"></div>
      </div>


      <div class='scale'>
        <div id = 'tempClass1' class='tempLabel'>7</div>
        <div id = 'tempClass2' class='tempLabel'>12</div>
        <div id = 'tempClass3' class='tempLabel'>17</div>
        <div id = 'tempClass4'class='tempLabel'>22</div>
        <div id = 'tempClass5' class='tempLabel'>27</div>
      </div>


    <!--  <div class= 'scale'></div> -->



      <div class='session' id='sliderbar'>
          <h5>2020 Climate Conditions </h5>
          <h6><label id='active-timestamp'>Mid-Century High Emissions RCP8.5 (Hot Scenario)</label></h6>
          <!--  <input id='slider' class='sliderConst' type='range' min='0' max='3' step='1' value='0' />
           ^^^slider somehow controls color bars/layer selection
          <div class= 'scale'>-->
          </div>
      </div>

<!--
      <div class='dynamicData' id='hoverinfo'>
 			    <h3>Active Layer Cell Value: <label id='hover-cell'>N/A</label></h3>
 	    </div>
-->
      <div class='dynamicData' id='firstLayerValue'><h2> 2020: &nbsp; <label id='hover-cell-1'>N/A</label></h2><div class='movableBar' id='movableBar1'></div></div>
      <div class='dynamicData' id='secondLayerValue'><h2><label id ='secondLayerLabel'>2050:</label> &nbsp; <label id='hover-cell-2'>N/A</label></h2><div class='movableBar' id='movableBar2'></div></div>


</div>

    <div id = 'consoleControl'><div id = 'ccText' class = 'consoleControlText'>Hide</div></div>


<div id = 'layerDropMenu' class = 'dropMenuClass'>
  <button id = 'dropbtn' class="dropbtn">Mid-Century Scenario</button>
    <div id = 'dropdown-content' class="dropdown-content">
      <h4>Mid-Century High Emissions RCP8.5 (Hot Scenario)</h4>
      <h4>Mid-Century High Emissions RCP8.5 + Cool Roofs</h4>
      <h4>Mid-Century Low Emissions RCP4.5 (Cool Scenario)</h4>
      <h4>Mid-Century Low Emissions RCP4.5 + Cool Roofs</h4>
    </div>

</div>


  <script src="sources.js"></script>
  <script src="layers.js"></script>



  <script>
  mapboxgl.accessToken = 'pk.eyJ1Ijoibm9haC1iIiwiYSI6ImNqbm5qNjdpcjA2dTczdnBna3o3NGVtdm4ifQ.Y-VCtr3LTcEgYsaYe4rt3A';


//NEW SYNC MAP TEST ZONE
//var mapboxgl = require('mapbox-gl');
//var syncMove = require('mapbox-gl-sync-move');



  var map = new mapboxgl.Map({
  container: 'mapLeft', // container element id
  style: 'mapbox://styles/noah-b/cjqztjm4f02h22qmpf3hvvk63',
  center: [ -117.838,33.458], // initial map center in [lon, lat]
  zoom: 7.8
  });


//GLOBAL VARIABLES
var GlobalLat = -117.838;
var GlobalLong = 33.458;
var GlobalZoom = 7.8;



//load the tileset
map.on('load', function() {

  var layers = map.getStyle().layers;
  var layer_IDs = [];
  var maxValue = 37; //this should change for each dataset
  var minValue = 3; //this should change for each dataset
  var barWidth = 150; //was 100 //measured in px, should change if legend is changed



//add 3-D
var labelLayerId;
  for (var i = 0; i < layers.length; i++) {
      if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
          labelLayerId = layers[i].id;
          break;
        }
}


   // Find the index of the first symbol layer in the map style
   var firstSymbolId;

   firstSymbolId = 'waterway-label';


    //load map sources
    mapSources.forEach(function(source) {
        let id = source[0];
        let obj = source[1];
        map.addSource(id, obj)
      });

    //load map layers
    mapLayers.forEach(function(layer) {
        let obj = layer[0];
        map.addLayer(obj, firstSymbolId);
        layer_IDs.push(obj.id); //adds names of all layers to an array
      });




      map.addLayer({
        'id': '3d-buildings',
        'source': 'composite',
        'source-layer': 'building',
        'filter': ['==', 'extrude', 'true'],
        'type': 'fill-extrusion',
        'minzoom': 15,
        'light': {"intensity":0.5,"anchor":"viewport"},
        'paint': {
            'fill-extrusion-color': 'white',
            // use an 'interpolate' expression to add a smooth transition effect to the
            // buildings as the user zooms in
            'fill-extrusion-height': [
            "interpolate", ["linear"], ["zoom"],
            15, 0,
            15.05, ["get", "height"]
            ],
            'fill-extrusion-base': [
            "interpolate", ["linear"], ["zoom"],
            15, 0,
            15.05, ["get", "min_height"]
            ],
            'fill-extrusion-opacity': 0.85,

            }
      }, firstSymbolId);



    //makes first layer visible at start
    map.setPaintProperty(layer_IDs[0], 'fill-opacity',0.65);


    //new dropdown menu control
    document.getElementById('dropdown-content').addEventListener('click', function(e) {
        var selected_Content = e.target.innerText;
        var selected_layer; //selected_layer gets layer ID
        var active_layer; // layer that is completely visible
        document.getElementById('dropbtn').innerText = selected_Content; //changes number next to timestamp
        document.getElementById('active-timestamp').innerText = selected_Content; //changes number next to timestamp


        for (var i = 0; i < layer_IDs.length; i++){
          var ID = layer_IDs[i];
          if (ID === selected_layer){ //TRY CHANGING THIS TO FEATURE STATE
            map.setPaintProperty(selected_layer, 'fill-opacity', 0.65);
          }
        }
        map.setPaintProperty(active_layer, 'fill-opacity', 0);
        //console.log(active_layer);

        //change color of 3-D layer
        //Need to loop through and change every grid id to its own color
        var buildingLayer = '3d-buildings';
        var features = map.queryRenderedFeatures(e.point, {layers: [selected_layer]}); //returns an array of objects
        var features1 = map.queryRenderedFeatures(e.point, {layers: ['3d-buildings']}); //returns an array of objects

        var myFeatures = map.querySourceFeatures('composite',
     {
         sourceLayer: 'building',
        // i'm confident there is data matching this filter
         filter: ["==", "type", "feature"]
     }
     );
     //console.log(features[0]);
     //console.log(features1[0]);
     //console.log(features1[0]._vectorTileFeature._x + " = x-coordinate"); //
     //console.log(features1.length);

        var gridcodeNum = features[0].properties.temp; //changed from gridcode to temp
        var buildingColor = detGridColor(gridcodeNum);
        map.setPaintProperty('3d-buildings', 'fill-extrusion-color', buildingColor);


    console.log(map.getLayer(features));


    });

    //Use everything in this event and move to the dropdown menu control^^^

function detGridColor(gridNum){
  var newColor = "";
  switch (true){
    case gridNum<timeSeriesStops[0]:
        newColor = timeSeriesColors[0];
        break;
    case gridNum<timeSeriesStops[1]:
      newColor = timeSeriesColors[1];
      break;
    case gridNum<timeSeriesStops[2]:
      newColor = timeSeriesColors[2];
      break;
    case gridNum<timeSeriesStops[3]:
      newColor = timeSeriesColors[3];
      break;
    case gridNum>=timeSeriesStops[3]:
      newColor = timeSeriesColors[4];
      break;
  }
  return newColor;
}


//changes legend color bar values
  document.getElementById('CtoFconverter').addEventListener("click", function(){
    if (document.getElementsByName('CtoFbutton')[0].checked){
      document.getElementById("tempClass1").innerHTML = "7";
      document.getElementById("tempClass2").innerHTML = "14";
      document.getElementById("tempClass3").innerHTML = "21";
      document.getElementById("tempClass4").innerHTML = "28";
      document.getElementById("tempClass5").innerHTML = "??";
    }
    else{
      document.getElementById("tempClass1").innerHTML = "44.6";
      document.getElementById("tempClass2").innerHTML = "53.6";
      document.getElementById("tempClass3").innerHTML = "62.6";
      document.getElementById("tempClass4").innerHTML = "71.6";
      document.getElementById("tempClass5").innerHTML = "80.6";



    }
  });

//Makes the legend vidible or hidden
  var consoleStatus = "visible";
  document.getElementById("consoleControl").addEventListener("click", function(){

    //if visible, make invisible and move button
    if (consoleStatus === "visible"){
      document.getElementById("console").style.visibility = "hidden";
      document.getElementById("consoleControl").style.left = "20px";
      document.getElementById("ccText").innerHTML = "Show";
      consoleStatus = "hidden";
    }
    //otherwise, make visible and move button back
    else{
      document.getElementById("consoleControl").style.left = "385px";
      document.getElementById("console").style.visibility = "visible";
      document.getElementById("ccText").innerHTML = "Hide";
      consoleStatus = "visible";

    }
  });

  //Change mouse cursor from pointer to arrow
  map.getCanvas().style.cursor = 'default';


//Gets value of cell hovered over
	map.on('mousemove', 'Current-v5' , function (e) { //'temp-current-v3 is arbitrary
    //Gets value for active layer
    //only needed here for hover
    var active_layer = document.getElementById('active-timestamp').innerText;
//added
    var active_layer_ID;

    if (active_layer === 'Mid-Century High Emissions RCP8.5 (Hot Scenario)') {
      active_layer_ID = 'Midcentury-rcp85-v5';
    }
    else if (active_layer === 'Mid-Century High Emissions RCP8.5 + Cool Roofs') {
      active_layer_ID = 'Midcentury-rcp85-coolroof-v5';
    }
    else if (active_layer === 'Mid-Century Low Emissions RCP4.5 (Cool Scenario)') {
      active_layer_ID = 'Midcentury-rcp45-v5';
    }
    else if (active_layer === 'Mid-Century Low Emissions RCP4.5 + Cool Roofs') {
      active_layer_ID = 'Midcentury-rcp45-coolroof-v5';
    }
    else {
      console.log('not working');
    }


      var visibleValue;

      var features = map.queryRenderedFeatures(e.point, {layers: ['Current-v5']}); //returns an array of objects
      //console.log(features[0]);
      var cell_value = features[0].properties.temp; //accesses gridcode object (CHANGED TO TEMP)
      var Cvalue = cell_value.toFixed(2) + "&deg;C"; //puts together celcius
      var Fvalue = (cell_value*1.8 + 32).toFixed(2) + "&deg;F"; //puts together farenheight


      var visibleValue2050;

      var features2050 = map.queryRenderedFeatures(e.point, {layers: [active_layer_ID]}); //returns an array of objects
      //console.log(features[0]);
      var cell_value2050 = features2050[0].properties.temp; //accesses gridcode object (CHANGED TO TEMP)
      var Cvalue2050 = cell_value.toFixed(2) + "&deg;C"; //puts together celcius
      var Fvalue2050 = (cell_value2050*1.8 + 32).toFixed(2) + "&deg;F"; //puts together farenheight







      // sets the dynamic values to celcius or farenheight
      if (document.getElementsByName('CtoFbutton')[0].checked){
        visibleValue = Cvalue;
        visibleValue2050 = Cvalue2050;
      }
      else{
        visibleValue = Fvalue;
        visibleValue2050 = Fvalue2050;
      }
      document.getElementById('hover-cell-1').innerHTML = visibleValue;
      document.getElementById('hover-cell-2').innerHTML = visibleValue2050;




      //Change movable bar length
      var barPercentage = (cell_value - minValue)/(maxValue - minValue)*barWidth;
      var newBarWidth = barPercentage + "px";
      var barID = "movableBar1";
      document.getElementById(barID).style.width = newBarWidth;

      //change movable bar color
      var newColor = "";
      switch (true){
        case cell_value<timeSeriesStops[0]:
            newColor = timeSeriesColors[0];
            break;
        case cell_value<timeSeriesStops[1]:
          newColor = timeSeriesColors[1];
          break;
        case cell_value<timeSeriesStops[2]:
          newColor = timeSeriesColors[2];
          break;
        case cell_value<timeSeriesStops[3]:
          newColor = timeSeriesColors[3];
          break;
        case cell_value<timeSeriesStops[4]:
          newColor = timeSeriesColors[4];
          break;
        case cell_value>=timeSeriesStops[4]:
          newColor = timeSeriesColors[5];
          break;
        }
      document.getElementById(barID).style.backgroundColor = newColor;


    //-----------

    //Change movable bar length
    var barPercentage2050 = (cell_value2050 - minValue)/(maxValue - minValue)*barWidth;
    var newBarWidth2050 = barPercentage2050 + "px";
    var barID2050 = "movableBar2";
    document.getElementById(barID2050).style.width = newBarWidth2050;

    //change movable bar color
    var newColor2050 = "";
    switch (true){
      case cell_value2050<timeSeriesStops[0]:
          newColor2050 = timeSeriesColors[0];
          break;
      case cell_value2050<timeSeriesStops[1]:
        newColor2050 = timeSeriesColors[1];
        break;
      case cell_value2050<timeSeriesStops[2]:
        newColor2050 = timeSeriesColors[2];
        break;
      case cell_value2050<timeSeriesStops[3]:
        newColor2050 = timeSeriesColors[3];
        break;
      case cell_value2050<timeSeriesStops[4]:
        newColor2050 = timeSeriesColors[4];
        break;
      case cell_value2050>=timeSeriesStops[4]:
        newColor2050 = timeSeriesColors[5];
        break;
      }
    document.getElementById(barID2050).style.backgroundColor = newColor2050;



	});
});



    //Added for mapRight
      var mapRight = new mapboxgl.Map({
      container: 'mapRight', // container element id
      style: 'mapbox://styles/noah-b/cjqztjm4f02h22qmpf3hvvk63',
      center: [ -117.838,33.458], // initial map center in [lon, lat]
      zoom: 7.8
      });


      mapRight.on('load', function() {

        var layers = mapRight.getStyle().layers;
        var layer_IDs = [];
        var maxValue = 37; //this should change for each dataset
        var minValue = 3; //this should change for each dataset
        var barWidth = 150; //measured in px, should change if legend is changed



      //add 3-D
      var labelLayerId;
        for (var i = 0; i < layers.length; i++) {
            if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
                labelLayerId = layers[i].id;
                break;
              }
      }


         // Find the index of the first symbol layer in the map style
         var firstSymbolId;

         firstSymbolId = 'waterway-label';


          //load map sources
          mapSources2.forEach(function(source) {
              let id = source[0];
              let obj = source[1];
              mapRight.addSource(id, obj)
            });

          //load map layers
          mapLayersRight.forEach(function(layer) {
              let obj = layer[0];
              mapRight.addLayer(obj, firstSymbolId);
              layer_IDs.push(obj.id); //adds names of all layers to an array
            });

            console.log(layer_IDs[1]);



            mapRight.addLayer({
              'id': '3d-buildings',
              'source': 'composite',
              'source-layer': 'building',
              'filter': ['==', 'extrude', 'true'],
              'type': 'fill-extrusion',
              'minzoom': 15,
              'light': {"intensity":0.5,"anchor":"viewport"},
              'paint': {
                  'fill-extrusion-color': 'white',
                  // use an 'interpolate' expression to add a smooth transition effect to the
                  // buildings as the user zooms in
                  'fill-extrusion-height': [
                  "interpolate", ["linear"], ["zoom"],
                  15, 0,
                  15.05, ["get", "height"]
                  ],
                  'fill-extrusion-base': [
                  "interpolate", ["linear"], ["zoom"],
                  15, 0,
                  15.05, ["get", "min_height"]
                  ],
                  'fill-extrusion-opacity': 0.85,

                  }
            }, firstSymbolId);







            var selected_layer_right;
            var active_layer_right = layer_IDs[1];

          //makes rcp4.5 layer visible at start
          mapRight.setPaintProperty(layer_IDs[1], 'fill-opacity',0.65);
          console.log("checkpoint1");



          mapRight.jumpTo({
            center: [GlobalLat, GlobalLong],
            zoom: GlobalZoom});


// Change RightMap visible layer when dropdown menu is clicked on
          document.getElementById('dropdown-content').addEventListener('click', function(e) {
            console.log("checkpoint2");

//if statement gets selected layer
            if (e.target.innerText === 'Mid-Century High Emissions RCP8.5 (Hot Scenario)') {
              selected_layer_right = 'Midcentury-rcp85-v5-RightMap';
              console.log("8.5");

            }
            else if (e.target.innerText === 'Mid-Century High Emissions RCP8.5 + Cool Roofs') {
              selected_layer_right = 'Midcentury-rcp85-coolroof-v5-RightMap';
              console.log("8.5 cool roof");

            }
            else if (e.target.innerText === 'Mid-Century Low Emissions RCP4.5 (Cool Scenario)') {
              selected_layer_right = 'Midcentury-rcp45-v5-RightMap';
              console.log("8.5");

            }
            else if (e.target.innerText === 'Mid-Century Low Emissions RCP4.5 + Cool Roofs') {
              selected_layer_right = 'Midcentury-rcp45-coolroof-v5-RightMap';
              console.log("8.5");

            }
            else {
              console.log('not working');
            }

            mapRight.setPaintProperty(active_layer_right, 'fill-opacity', 0);
            mapRight.setPaintProperty(selected_layer_right, 'fill-opacity', 0.65);

            active_layer_right = selected_layer_right;


            //Next add in data readability

          });

          mapRight.getCanvas().style.cursor = 'default';

//--------------------------

//Gets value of cell hovered over


	mapRight.on('mousemove', 'Midcentury-rcp85-v5-RightMap' , function (e) { //'temp-current-v3 is arbitrary

    //Gets value for active layer
    var active_layer_right = document.getElementById('active-timestamp').innerText;
    //Note that the inner text will need to be changed to the layer name at some point
    var active_layer_right_ID;

//this can be changed if I have the active layer b/c I don't need all the values...




//if statement gets selected layer (can probably be out of the move function)
            if (active_layer_right === 'Mid-Century High Emissions RCP8.5 (Hot Scenario)') {
              active_layer_right_ID = 'Midcentury-rcp85-v5-RightMap';
            }
            else if (active_layer_right === 'Mid-Century High Emissions RCP8.5 + Cool Roofs') {
              active_layer_right_ID = 'Midcentury-rcp85-coolroof-v5-RightMap';
            }
            else if (active_layer_right === 'Mid-Century Low Emissions RCP4.5 (Cool Scenario)') {
              active_layer_right_ID = 'Midcentury-rcp45-v5-RightMap';
            }
            else if (active_layer_right === 'Mid-Century Low Emissions RCP4.5 + Cool Roofs') {
              active_layer_right_ID = 'Midcentury-rcp45-coolroof-v5-RightMap';
            }
            else {
              console.log('not working');
            }


      var visibleValue;
      var visibleCurValue;
      //var current_layer = 'time-series' + (i+1);
      var current_layer = layer_IDs[i]; //can be replcaed by active_layer_right_ID
      //var divID = 'hover-cell-' + (i+1);


      //Changes calues for the 2050 selected scenario when hovering over right map
      var features = mapRight.queryRenderedFeatures(e.point, {layers: [active_layer_right_ID]}); //returns an array of objects
      var cell_value = features[0].properties.temp; //accesses gridcode object (CHANGED TO TEMP)
      var Cvalue = cell_value.toFixed(2) + "&deg;C"; //puts together celcius
      var Fvalue = (cell_value*1.8 + 32).toFixed(2) + "&deg;F"; //puts together farenheight


      //Changes value for the 2020 scenario when hovering over RightMap
      var CurFeatures = mapRight.queryRenderedFeatures(e.point, {layers: [layer_IDs[0]]});
      var Curcell_value = CurFeatures[0].properties.temp; //accesses gridcode object (CHANGED TO TEMP)
      var CurCvalue = Curcell_value.toFixed(2) + "&deg;C"; //puts together celcius
      var CurFvalue = (Curcell_value*1.8 + 32).toFixed(2) + "&deg;F"; //puts together farenheight

      // sets the dynamic values to celcius or farenheight
      if (document.getElementsByName('CtoFbutton')[0].checked){
        visibleValue = Cvalue;
        visibleCurValue = CurCvalue;
      }
      else{
        visibleValue = Fvalue;
        visibleCurValue = CurFvalue;
      }

      //change this ID to the div ID of the text
      document.getElementById('hover-cell-2').innerHTML = visibleValue;
      document.getElementById('hover-cell-1').innerHTML = visibleCurValue;


      //Change movable bar length
      var barPercentage = (cell_value - minValue)/(maxValue - minValue)*barWidth;
      var newBarWidth = barPercentage + "px";
      var barID = "movableBar2";
      document.getElementById(barID).style.width = newBarWidth;


      //change movable bar color
      var newColor = "";
      switch (true){
        case cell_value<timeSeriesStops[0]:
            newColor = timeSeriesColors[0];
            break;
        case cell_value<timeSeriesStops[1]:
          newColor = timeSeriesColors[1];
          break;
        case cell_value<timeSeriesStops[2]:
          newColor = timeSeriesColors[2];
          break;
        case cell_value<timeSeriesStops[3]:
          newColor = timeSeriesColors[3];
          break;
        case cell_value<timeSeriesStops[4]:
          newColor = timeSeriesColors[4];
          break;
        case cell_value>=timeSeriesStops[4]:
          newColor = timeSeriesColors[5];
          break;
      }
      document.getElementById("movableBar2").style.backgroundColor = newColor;


//Change bar color and width for cur layers

//Change movable bar length
var CurbarPercentage = (Curcell_value - minValue)/(maxValue - minValue)*barWidth;
var CurnewBarWidth = CurbarPercentage + "px";
var CurbarID = "movableBar1";
document.getElementById(CurbarID).style.width = CurnewBarWidth;


//change movable bar color
var CurnewColor = "";
switch (true){
  case Curcell_value<timeSeriesStops[0]:
      CurnewColor = timeSeriesColors[0];
      break;
  case Curcell_value<timeSeriesStops[1]:
    CurnewColor = timeSeriesColors[1];
    break;
  case Curcell_value<timeSeriesStops[2]:
    CurnewColor = timeSeriesColors[2];
    break;
  case Curcell_value<timeSeriesStops[3]:
    CurnewColor = timeSeriesColors[3];
    break;
  case Curcell_value<timeSeriesStops[4]:
    CurnewColor = timeSeriesColors[4];
    break;
  case Curcell_value>=timeSeriesStops[4]:
    CurnewColor = timeSeriesColors[5];
    break;
}
document.getElementById("movableBar1").style.backgroundColor = CurnewColor;




	});


});


//NEW SYNC MAP TEST
syncMaps(map, mapRight);




  </script>

</body>
</html>
